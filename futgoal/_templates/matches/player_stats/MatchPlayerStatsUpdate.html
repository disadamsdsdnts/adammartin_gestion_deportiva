{% extends "layout/LayoutBase.html" %}
{% load i18n %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{% trans "Editar Estadística" %} - {{ object.player.full_name }}</h3>
        </div>

        <form method="post">
          {% csrf_token %}
          <div class="card-body">
            <!-- Información del registro actual -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="alert alert-info">
                  <div class="d-flex align-items-center">
                    {% if object.player.photo %}
                    <img src="{{ object.player.photo.url }}" class="rounded-circle me-3" width="50" height="50"
                      alt="{{ object.player.full_name }}">
                    {% else %}
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-3"
                      style="width: 50px; height: 50px;">
                      <i class="bi bi-person-fill text-white"></i>
                    </div>
                    {% endif %}
                    <div>
                      <h6 class="mb-1">{{ object.player.full_name }}{% if object.player.sport_name %}
                        "{{ object.player.sport_name }}"{% endif %}</h6>
                      <p class="mb-0 text-muted">{{ object.match }} - {{ object.match.match_date|date:"d/m/Y" }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Información Principal -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label required">{{ form.player.label }}</label>
                  {{ form.player|add_class:"form-select" }}
                  {% if form.player.errors %}
                  <div class="text-danger">{{ form.player.errors.0 }}</div>
                  {% endif %}
                  {% if form.player.help_text %}
                  <div class="form-text">{{ form.player.help_text }}</div>
                  {% endif %}
                </div>

                <div class="mb-3">
                  <div class="form-check">
                    {{ form.attended }}
                    <label class="form-check-label" for="{{ form.attended.id_for_label }}">
                      {{ form.attended.label }}
                    </label>
                  </div>
                  {% if form.attended.errors %}
                  <div class="text-danger">{{ form.attended.errors.0 }}</div>
                  {% endif %}
                  {% if form.attended.help_text %}
                  <div class="form-text">{{ form.attended.help_text }}</div>
                  {% endif %}
                </div>

                <div class="mb-3">
                  <label class="form-label required">{{ form.match.label }}</label>
                  {{ form.match|add_class:"form-select" }}
                  {% if form.match.errors %}
                  <div class="text-danger">{{ form.match.errors.0 }}</div>
                  {% endif %}
                  {% if form.match.help_text %}
                  <div class="form-text">{{ form.match.help_text }}</div>
                  {% endif %}
                </div>

                <div class="mb-3">
                  <label class="form-label">{{ form.status.label }}</label>
                  {{ form.status|add_class:"form-select" }}
                  {% if form.status.errors %}
                  <div class="text-danger">{{ form.status.errors.0 }}</div>
                  {% endif %}
                  {% if form.status.help_text %}
                  <div class="form-text">{{ form.status.help_text }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Tiempo de Juego -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">{{ form.minutes_played.label }}</label>
                  {{ form.minutes_played|add_class:"form-control" }}
                  {% if form.minutes_played.errors %}
                  <div class="text-danger">{{ form.minutes_played.errors.0 }}</div>
                  {% endif %}
                  {% if form.minutes_played.help_text %}
                  <div class="form-text">{{ form.minutes_played.help_text }}</div>
                  {% endif %}
                </div>

                <div class="row">
                  <div class="col-6">
                    <div class="mb-3">
                      <label class="form-label">{{ form.substitution_in.label }}</label>
                      {{ form.substitution_in|add_class:"form-control" }}
                      {% if form.substitution_in.errors %}
                      <div class="text-danger">{{ form.substitution_in.errors.0 }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="mb-3">
                      <label class="form-label">{{ form.substitution_out.label }}</label>
                      {{ form.substitution_out|add_class:"form-control" }}
                      {% if form.substitution_out.errors %}
                      <div class="text-danger">{{ form.substitution_out.errors.0 }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Estadísticas de Rendimiento -->
            <div class="row mt-4">
              <div class="col-12">
                <h5>{% trans "Estadísticas de Rendimiento" %}</h5>
                <hr>
              </div>
            </div>

            <div class="row">
              <div class="col-md-2 col-sm-4 col-6">
                <div class="mb-3">
                  <label class="form-label">{{ form.goals.label }}</label>
                  <div class="input-group">
                    {{ form.goals|add_class:"form-control" }}
                    <span class="input-group-text">
                      <i class="bi bi-trophy text-success"></i>
                    </span>
                  </div>
                  {% if form.goals.errors %}
                  <div class="text-danger">{{ form.goals.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-2 col-sm-4 col-6">
                <div class="mb-3">
                  <label class="form-label">{{ form.assists.label }}</label>
                  <div class="input-group">
                    {{ form.assists|add_class:"form-control" }}
                    <span class="input-group-text">
                      <i class="bi bi-hand-thumbs-up text-info"></i>
                    </span>
                  </div>
                  {% if form.assists.errors %}
                  <div class="text-danger">{{ form.assists.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-2 col-sm-4 col-6">
                <div class="mb-3">
                  <label class="form-label">{{ form.yellow_cards.label }}</label>
                  <div class="input-group">
                    {{ form.yellow_cards|add_class:"form-control" }}
                    <span class="input-group-text">
                      <i class="bi bi-square-fill text-warning"></i>
                    </span>
                  </div>
                  {% if form.yellow_cards.errors %}
                  <div class="text-danger">{{ form.yellow_cards.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-2 col-sm-4 col-6">
                <div class="mb-3">
                  <label class="form-label">{{ form.red_cards.label }}</label>
                  <div class="input-group">
                    {{ form.red_cards|add_class:"form-control" }}
                    <span class="input-group-text">
                      <i class="bi bi-square-fill text-danger"></i>
                    </span>
                  </div>
                  {% if form.red_cards.errors %}
                  <div class="text-danger">{{ form.red_cards.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-2 col-sm-4 col-6">
                <div class="mb-3">
                  <label class="form-label">{{ form.rating.label }}</label>
                  <div class="input-group">
                    {{ form.rating|add_class:"form-control" }}
                    <span class="input-group-text">
                      <i class="bi bi-star text-secondary"></i>
                    </span>
                  </div>
                  {% if form.rating.errors %}
                  <div class="text-danger">{{ form.rating.errors.0 }}</div>
                  {% endif %}
                  {% if form.rating.help_text %}
                  <div class="form-text">{{ form.rating.help_text }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Notas de Rendimiento -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label">{{ form.performance_notes.label }}</label>
                  {{ form.performance_notes|add_class:"form-control" }}
                  {% if form.performance_notes.errors %}
                  <div class="text-danger">{{ form.performance_notes.errors.0 }}</div>
                  {% endif %}
                  {% if form.performance_notes.help_text %}
                  <div class="form-text">{{ form.performance_notes.help_text }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Comparación de Cambios -->
            {% if object.modified != object.created %}
            <div class="row mt-4">
              <div class="col-12">
                <div class="alert alert-warning">
                  <h6 class="alert-heading">{% trans "Información de Modificación" %}</h6>
                  <p class="mb-0">
                    {% trans "Creado:" %} {{ object.created|date:"d/m/Y H:i" }}<br>
                    {% trans "Última modificación:" %} {{ object.modified|date:"d/m/Y H:i" }}
                  </p>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Información de Ayuda -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="alert alert-info">
                  <h6 class="alert-heading">{% trans "Información Importante" %}</h6>
                  <ul class="mb-0">
                    <li>
                      {% trans "Los jugadores de banquillo no pueden tener estadísticas de juego (goles, asistencias, tarjetas, etc.)" %}
                    </li>
                    <li>{% trans "Los jugadores con tarjeta roja no pueden tener más de una tarjeta amarilla" %}</li>
                    <li>{% trans "Los minutos jugados deben estar entre 0 y 120" %}</li>
                    <li>{% trans "La calificación debe estar entre 0 y 10" %}</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="card-footer">
            <div class="d-flex justify-content-between">
              <div>
                <a href="{% url 'matches:player_stats_detail' object.pk %}" class="btn btn-secondary">
                  <i class="bi bi-arrow-left"></i>
                  {% trans "Cancelar" %}
                </a>
                <a href="{% url 'matches:player_stats_list' %}" class="btn btn-outline-secondary">
                  <i class="bi bi-list"></i>
                  {% trans "Ver Lista" %}
                </a>
              </div>
              <div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save"></i>
                  {% trans "Guardar Cambios" %}
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Manejar cambios en el estado del jugador
    const statusField = document.getElementById('id_status');
    const gameStatsFields = ['id_goals', 'id_assists', 'id_yellow_cards', 'id_red_cards', 'id_minutes_played',
      'id_rating'
    ];

    function toggleGameStats() {
      const isBench = statusField.value === 'bench' || statusField.value === 'not_available';

      gameStatsFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          if (isBench) {
            field.disabled = true;
            if (fieldId !== 'id_minutes_played') {
              field.value = '';
            }
            field.style.opacity = '0.5';
          } else {
            field.disabled = false;
            field.style.opacity = '1';
          }
        }
      });

      // Si está en banquillo, poner minutos en 0
      if (isBench) {
        const minutesField = document.getElementById('id_minutes_played');
        if (minutesField) {
          minutesField.value = '0';
        }
      }
    }

    if (statusField) {
      statusField.addEventListener('change', toggleGameStats);
      toggleGameStats(); // Ejecutar al cargar la página
    }

    // Validación de tarjetas
    const yellowCards = document.getElementById('id_yellow_cards');
    const redCards = document.getElementById('id_red_cards');

    function validateCards() {
      if (yellowCards && redCards) {
        const yellowValue = parseInt(yellowCards.value) || 0;
        const redValue = parseInt(redCards.value) || 0;

        if (redValue > 0 && yellowValue > 1) {
          redCards.setCustomValidity(
            '{% trans "Un jugador con tarjeta roja no puede tener más de una tarjeta amarilla" %}');
        } else {
          redCards.setCustomValidity('');
        }
      }
    }

    if (yellowCards && redCards) {
      yellowCards.addEventListener('input', validateCards);
      redCards.addEventListener('input', validateCards);
    }
  });

</script>
{% endblock %}
